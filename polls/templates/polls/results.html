{% extends "polls/base.html" %}
<!-- 
PLANTILLA DE RESULTADOS DE ENCUESTA - results.html

PROP√ìSITO:
Esta plantilla muestra los resultados de una encuesta espec√≠fica con:
- Gr√°ficos visuales (barras y circular)
- Estad√≠sticas detalladas
- Actualizaci√≥n en tiempo real
- Informaci√≥n de participaci√≥n

CARACTER√çSTICAS PRINCIPALES:
1. Visualizaci√≥n de datos con Chart.js
2. Actualizaci√≥n autom√°tica cada 30 segundos
3. Estad√≠sticas completas (total votos, opciones, ganador)
4. Dise√±o responsivo y atractivo
5. Informaci√≥n temporal de la encuesta

TECNOLOG√çAS UTILIZADAS:
- Django Template Language: L√≥gica de presentaci√≥n
- Chart.js: Librer√≠a para gr√°ficos interactivos
- Bootstrap 5: Framework CSS responsivo
- JavaScript: Interactividad y actualizaci√≥n autom√°tica
- Font Awesome: Iconograf√≠a

FLUJO DE DATOS:
Vista results() ‚Üí Contexto con estad√≠sticas ‚Üí Esta plantilla ‚Üí 
Renderizado con gr√°ficos ‚Üí Actualizaci√≥n peri√≥dica v√≠a AJAX
-->

<!-- 
T√çTULO DIN√ÅMICO DE LA P√ÅGINA:
Se muestra en la pesta√±a del navegador
Incluye el texto de la pregunta para mejor identificaci√≥n
-->
{% block title %}Resultados: {{ question.question_text }} - Encuestas App{% endblock %}

<!-- 
CONTENIDO PRINCIPAL DE LA P√ÅGINA:
Todo el contenido espec√≠fico para mostrar resultados
-->
{% block content %}

<!-- 
ESTRUCTURA PRINCIPAL DE LA P√ÅGINA DE RESULTADOS
Usa un layout m√°s ancho que la p√°gina de votaci√≥n para acomodar gr√°ficos
-->
<div class="row">
    <!-- 
    CONTENEDOR PRINCIPAL:
    - col-lg-10: En pantallas grandes ocupa 10 de 12 columnas (83%)
    - mx-auto: Centrado horizontalmente
    - M√°s ancho que detail.html para mostrar gr√°ficos c√≥modamente
    -->
    <div class="col-lg-10 mx-auto">
        
        <!-- 
        TARJETA PRINCIPAL DE RESULTADOS:
        Contiene todos los elementos de visualizaci√≥n de datos
        -->
        <div class="card shadow-lg border-0 fade-in">
            
            <!-- 
            ENCABEZADO DE RESULTADOS:
            - bg-success: Color verde para indicar "resultados exitosos"
            - Incluye indicadores de actualizaci√≥n en tiempo real
            -->
            <div class="card-header bg-success text-white">
                <!-- 
                LAYOUT FLEXBOX:
                Distribuye el t√≠tulo a la izquierda y los indicadores a la derecha
                -->
                <div class="d-flex justify-content-between align-items-center">
                    <!-- T√çTULO PRINCIPAL -->
                    <h1 class="h4 mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Resultados en Tiempo Real
                    </h1>
                    <!-- 
                    INDICADORES DE ACTUALIZACI√ìN:
                    Muestran el estado de la actualizaci√≥n autom√°tica
                    -->
                    <div class="d-flex align-items-center">
                        <!-- 
                        BADGE DE ESTADO:
                        Indica que la p√°gina se est√° actualizando
                        -->
                        <span class="badge bg-light text-dark me-2">
                            <!-- 
                            √çCONO ROTATIVO:
                            id="refreshIcon" permite controlarlo con JavaScript
                            para mostrar animaci√≥n de carga
                            -->
                            <i class="fas fa-sync-alt me-1" id="refreshIcon"></i>
                            Actualizando...
                        </span>
                        <!-- 
                        TIMESTAMP DE √öLTIMA ACTUALIZACI√ìN:
                        Se actualiza din√°micamente con JavaScript
                        -->
                        <small id="lastUpdate">
                            <i class="fas fa-clock me-1"></i>
                            Ahora
                        </small>
                    </div>
                </div>
            </div>
            <!-- 
            CUERPO PRINCIPAL DE LA TARJETA:
            Contiene toda la informaci√≥n y gr√°ficos de resultados
            -->
            <div class="card-body p-4">
                
                <!-- 
                SECCI√ìN DE PREGUNTA Y ESTAD√çSTICAS GENERALES:
                Muestra el contexto de la encuesta y n√∫meros principales
                -->
                <div class="mb-4">
                    <!-- 
                    PREGUNTA PRINCIPAL:
                    Repetimos la pregunta para que el usuario tenga contexto
                    -->
                    <h2 class="text-primary mb-3">{{ question.question_text }}</h2>
                    
                    <!-- 
                    ESTAD√çSTICAS PRINCIPALES:
                    Dashboard con m√©tricas clave de la encuesta
                    -->
                    <div class="row mb-4">
                        <!-- 
                        ESTAD√çSTICA 1: TOTAL DE VOTOS
                        -->
                        <div class="col-md-4">
                            <div class="stat-card">
                                <!-- 
                                N√öMERO PRINCIPAL:
                                id="totalVotes" permite actualizaci√≥n din√°mica
                                total_votes viene del contexto de la vista
                                -->
                                <div class="stat-number" id="totalVotes">{{ total_votes }}</div>
                                <div>
                                    <!-- 
                                    TEXTO DESCRIPTIVO CON PLURALIZACI√ìN:
                                    |pluralize agrega 's' si no es singular
                                    |pluralize:"es" agrega 'es' para "Total/Totales"
                                    -->
                                    Voto{{ total_votes|pluralize }} Total{{ total_votes|pluralize:"es" }}
                                </div>
                            </div>
                        </div>
                        <!-- 
                        ESTAD√çSTICA 2: N√öMERO DE OPCIONES
                        -->
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number">
                                    <!-- 
                                    CONTAR OPCIONES:
                                    choices_with_stats es una lista preparada en la vista
                                    |length cuenta cu√°ntos elementos tiene
                                    -->
                                    {{ choices_with_stats|length }}
                                </div>
                                <!-- 
                                DESCRIPCI√ìN:
                                Texto descriptivo de la estad√≠stica
                                -->
                                <div>Opcion{{ choices_with_stats|length|pluralize:"es" }}</div>
                            </div>
                        </div>
                        <!-- 
                        ESTAD√çSTICA 3: PARTICIPACI√ìN DEL USUARIO
                        -->
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number">
                                    <!-- 
                                    INDICADOR VISUAL DE PARTICIPACI√ìN:
                                    Muestra si el usuario actual ya vot√≥ o no
                                    user_vote es pasado desde la vista
                                    -->
                                    {% if user_vote %}
                                        <i class="fas fa-check-circle"></i>
                                    {% else %}
                                        <i class="fas fa-minus-circle"></i>
                                    {% endif %}
                                </div>
                                <div>Tu Participaci√≥n</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 
                SECCI√ìN PRINCIPAL: RESULTADOS POR OPCI√ìN
                Solo se muestra si hay votos registrados
                -->
                {% if total_votes > 0 %}
                    <div class="mb-4">
                        <!-- 
                        T√çTULO DE LA SECCI√ìN:
                        Encabezado para la lista de resultados
                        -->
                        <h4 class="text-secondary mb-3">
                            <i class="fas fa-poll me-2"></i>
                            Distribuci√≥n de Votos:
                        </h4>
                        
                        <!-- 
                        CONTENEDOR DE RESULTADOS:
                        id="resultsContainer" permite actualizaci√≥n din√°mica con JavaScript
                        -->
                        <div id="resultsContainer">
                            <!-- 
                            BUCLE PARA CADA OPCI√ìN CON ESTAD√çSTICAS:
                            choices_with_stats viene preparado desde la vista con:
                            - choice: El objeto Choice
                            - vote_count: N√∫mero de votos
                            - percentage: Porcentaje calculado
                            -->
                            {% for choice_stat in choices_with_stats %}
                                <!-- 
                                ITEM INDIVIDUAL DE RESULTADO:
                                - .result-item: Clase CSS personalizada
                                - data-choice-id: Atributo para identificaci√≥n en JavaScript
                                -->
                                <div class="mb-4 result-item" data-choice-id="{{ choice_stat.choice.id }}">
                                    
                                    <!-- 
                                    ENCABEZADO DE LA OPCI√ìN:
                                    Muestra el texto y marcadores especiales
                                    -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            <!-- TEXTO DE LA OPCI√ìN -->
                                            <h6 class="mb-0 me-2">{{ choice_stat.choice.choice_text }}</h6>
                                            <!-- 
                                            MARCADOR DE VOTO DEL USUARIO:
                                            Solo se muestra si el usuario vot√≥ por esta opci√≥n
                                            -->
                                            {% if user_vote and user_vote.id == choice_stat.choice.id %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-vote-yea me-1"></i>Tu voto
                                                </span>
                                            {% endif %}
                                        </div>
                                        <!-- 
                                        ESTAD√çSTICAS NUM√âRICAS:
                                        Muestran votos y porcentaje en el lado derecho
                                        -->
                                        <div class="text-end">
                                            <!-- 
                                            N√öMERO DE VOTOS:
                                            - data-votes: Atributo para actualizaci√≥n con JavaScript
                                            - choice_stat.votes: Calculado en la vista
                                            -->
                                            <span class="fw-bold text-primary fs-5" data-votes="{{ choice_stat.votes }}">
                                                {{ choice_stat.votes }}
                                            </span>
                                            <small class="text-muted ms-1">
                                                <!-- 
                                                PORCENTAJE:
                                                - data-percentage: Para actualizaci√≥n JavaScript
                                                - choice_stat.percentage: Calculado en la vista
                                                -->
                                                (<span data-percentage="{{ choice_stat.percentage }}">{{ choice_stat.percentage }}</span>%)
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- 
                                    BARRA DE PROGRESO VISUAL:
                                    Representaci√≥n gr√°fica del porcentaje de votos
                                    -->
                                    <div class="position-relative">
                                        <!-- Barra s√∫per simple que S√ç funciona -->
                                        <div style="background-color: #e9ecef; height: 40px; border-radius: 15px; position: relative;">
                                            {% if choice_stat.percentage > 0 %}
                                            <div style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: {{ choice_stat.percentage }}%; border-radius: 15px;"></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- 
                    SECCI√ìN DE GR√ÅFICO CIRCULAR:
                    Visualizaci√≥n alternativa usando Chart.js
                    -->
                    <div class="mb-4">
                        <h4 class="text-secondary mb-3">
                            <i class="fas fa-chart-pie me-2"></i>
                            Vista Gr√°fica:
                        </h4>
                        <div class="text-center">
                            <!-- 
                            CANVAS PARA CHART.JS:
                            - id="resultsChart": Identificador para JavaScript
                            - width/height: Dimensiones del canvas
                            Chart.js dibujar√° el gr√°fico circular aqu√≠
                            -->
                            <canvas id="resultsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                {% else %}
                    <!-- 
                    CASO ESPECIAL: SIN VOTOS
                    Se muestra cuando total_votes == 0
                    -->
                    <!-- 
                    MENSAJE PARA ENCUESTA SIN VOTOS:
                    Pantalla amigable que invita a la participaci√≥n
                    -->
                    <div class="text-center py-5">
                        <!-- √çCONO GRANDE DECORATIVO -->
                        <i class="fas fa-vote-yea fa-5x text-muted mb-3"></i>
                        <!-- T√çTULO DEL MENSAJE -->
                        <h4 class="text-muted">A√∫n no hay votos</h4>
                        <!-- TEXTO MOTIVACIONAL -->
                        <p class="text-muted lead">
                            ¬°S√© el primero en votar en esta encuesta!
                        </p>
                        <!-- 
                        ENLACE PARA VOTAR:
                        Redirige a la p√°gina de detalle para que puedan votar
                        -->
                        <a href="{% url 'polls:detail' question.id %}" class="btn btn-primary btn-lg btn-custom">
                            <i class="fas fa-vote-yea me-2"></i>
                            Votar Ahora
                        </a>
                    </div>
                {% endif %}
                
                <!-- Informaci√≥n adicional -->
                {% if user_vote %}
                    <div class="alert alert-success border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle fa-2x me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">¬°Gracias por participar!</h6>
                                <p class="mb-0">
                                    Tu voto por <strong>"{{ user_vote.choice_text }}"</strong> ha sido contabilizado.
                                    Los resultados se actualizan autom√°ticamente cada 5 segundos.
                                </p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">¬øQuieres participar?</h6>
                                <p class="mb-2">
                                    A√∫n puedes votar en esta encuesta y ver c√≥mo tu voto afecta los resultados.
                                </p>
                                <a href="{% url 'polls:detail' question.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-vote-yea me-1"></i>
                                    Ir a votar
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Footer -->
            <div class="card-footer bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            Publicada el {{ question.pub_date|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{% url 'polls:index' %}" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="fas fa-arrow-left me-1"></i>
                            Volver a la lista
                        </a>
                        <a href="{% url 'polls:detail' question.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-vote-yea me-1"></i>
                            {% if user_vote %}Ver encuesta{% else %}Votar{% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informaci√≥n sobre actualizaciones en tiempo real -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="bg-light p-3 rounded border">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="text-primary mb-1">
                                <i class="fas fa-sync-alt me-2"></i>
                                Actualizaci√≥n en Tiempo Real
                            </h6>
                            <small class="text-muted">
                                Los resultados se actualizan autom√°ticamente cada 5 segundos sin recargar la p√°gina.
                            </small>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="manualRefresh()">
                                <i class="fas fa-sync me-1"></i>
                                Actualizar Ahora
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Estilos espec√≠ficos para la p√°gina de resultados */
    
    .result-item {
        animation: slideInLeft 0.5s ease-out forwards;
        opacity: 0;
        transform: translateX(-20px);
    }
    
    .result-item:nth-child(1) { animation-delay: 0.1s; }
    .result-item:nth-child(2) { animation-delay: 0.2s; }
    .result-item:nth-child(3) { animation-delay: 0.3s; }
    .result-item:nth-child(4) { animation-delay: 0.4s; }
    .result-item:nth-child(5) { animation-delay: 0.5s; }
    
    @keyframes slideInLeft {
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .updating {
        animation: pulse 1s ease-in-out;
    }
    
    #refreshIcon {
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

<!-- 
BLOQUE JAVASCRIPT PERSONALIZADO:
JavaScript espec√≠fico para la p√°gina de resultados
-->
{% block extra_js %}
<!-- 
LIBRER√çA CHART.JS:
CDN externo para crear gr√°ficos interactivos
Permite crear gr√°ficos de barras, l√≠neas, circular, etc.
-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    /* 
    JAVASCRIPT PARA RESULTADOS EN TIEMPO REAL
    
    Este c√≥digo maneja:
    1. Creaci√≥n de gr√°ficos con Chart.js
    2. Actualizaci√≥n autom√°tica de datos
    3. Animaciones de barras de progreso
    4. Efectos visuales din√°micos
    */
    
    // VARIABLES GLOBALES
    let chart = null;           // Referencia al gr√°fico de Chart.js
    let refreshInterval = null; // Intervalo para actualizaci√≥n autom√°tica
    
    // EVENTO: Cuando termina de cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar el gr√°fico circular
        initChart();
        
        // Configurar actualizaci√≥n autom√°tica cada 30 segundos
        startAutoRefresh();
        
        // Animar las barras de progreso al cargar
        animateProgressBars();
    });
    
    /**
     * INICIALIZAR EL GR√ÅFICO DE PASTEL CON CHART.JS
     * 
     * Crea un gr√°fico circular interactivo mostrando la distribuci√≥n de votos
     */
    function initChart() {
        // Obtener el elemento canvas donde se dibujar√° el gr√°fico
        const ctx = document.getElementById('resultsChart');
        
        // Si no existe el canvas o no hay votos, no crear gr√°fico
        if (!ctx || {{ total_votes }} === 0) return;
        
        // DATOS DEL GR√ÅFICO
        const data = {
            // ETIQUETAS: Texto de cada opci√≥n de la encuesta
            labels: [
                <!-- 
                BUCLE DJANGO DENTRO DE JAVASCRIPT:
                Genera un array de JavaScript con las opciones
                |escapejs escapa caracteres especiales para JavaScript
                -->
                {% for choice_stat in choices_with_stats %}
                    "{{ choice_stat.choice.choice_text|escapejs }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                // VALORES: N√∫mero de votos de cada opci√≥n
                data: [
                    {% for choice_stat in choices_with_stats %}
                        {{ choice_stat.votes }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                // COLORES: Array de colores para cada secci√≥n
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
                    '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8'
                ],
                borderWidth: 2,    // Grosor del borde
                borderColor: '#fff' // Color del borde (blanco)
            }]
        };
        
        // CONFIGURACI√ìN DEL GR√ÅFICO
        const config = {
            type: 'doughnut',  // Tipo: gr√°fico de dona (circular con hueco)
            data: data,
            options: {
                responsive: true,              // Se adapta al tama√±o del contenedor
                maintainAspectRatio: false,   // Permite cambiar la proporci√≥n
                plugins: {
                    legend: {
                        position: 'bottom',   // Leyenda en la parte inferior
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} votos (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true
                }
            }
        };
        
        chart = new Chart(ctx, config);
    }
    
    /**
     * Inicia la actualizaci√≥n autom√°tica cada 5 segundos
     */
    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            updateResults();
        }, 5000);
    }
    
    /**
     * Detiene la actualizaci√≥n autom√°tica
     */
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    }
    
    /**
     * Actualiza los resultados mediante AJAX
     */
    function updateResults() {
        fetch(`{% url 'polls:live_results_api' question.id %}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateUI(data);
                    updateLastRefreshTime();
                } else {
                    console.error('Error al obtener resultados:', data.error);
                }
            })
            .catch(error => {
                console.error('Error de conexi√≥n:', error);
            });
    }
    
    /**
     * Actualiza la interfaz con los nuevos datos
     */
    function updateUI(data) {
        // Actualizar total de votos
        const totalVotesElement = document.getElementById('totalVotes');
        if (totalVotesElement) {
            const oldTotal = parseInt(totalVotesElement.textContent);
            const newTotal = data.total_votes;
            
            if (oldTotal !== newTotal) {
                totalVotesElement.classList.add('updating');
                animateNumber(totalVotesElement, oldTotal, newTotal);
                setTimeout(() => {
                    totalVotesElement.classList.remove('updating');
                }, 1000);
            }
        }
        
        // Actualizar resultados individuales
        Object.entries(data.results).forEach(([choiceId, result]) => {
            const resultItem = document.querySelector(`[data-choice-id="${choiceId}"]`);
            if (resultItem) {
                // Actualizar n√∫mero de votos
                const votesElement = resultItem.querySelector('[data-votes]');
                if (votesElement) {
                    const oldVotes = parseInt(votesElement.getAttribute('data-votes'));
                    const newVotes = result.votes;
                    
                    if (oldVotes !== newVotes) {
                        votesElement.setAttribute('data-votes', newVotes);
                        animateNumber(votesElement, oldVotes, newVotes);
                    }
                }
                
                // Actualizar porcentaje
                const percentageElement = resultItem.querySelector('[data-percentage]');
                if (percentageElement) {
                    percentageElement.setAttribute('data-percentage', result.percentage);
                    percentageElement.textContent = result.percentage;
                }
                
                // Actualizar barra de progreso
                const progressBar = resultItem.querySelector('.result-bar');
                if (progressBar) {
                    const newWidth = result.percentage > 0 ? Math.max(result.percentage, 1) : 0;
                    progressBar.style.width = `${newWidth}%`;
                    progressBar.setAttribute('data-width', newWidth);
                    
                    // Actualizar texto dentro de la barra
                    if (result.percentage > 15) {
                        progressBar.textContent = `${result.percentage}%`;
                    } else {
                        progressBar.textContent = '';
                    }
                }
            }
        });
        
        // Actualizar gr√°fico
        if (chart && data.total_votes > 0) {
            const newData = Object.values(data.results).map(result => result.votes);
            chart.data.datasets[0].data = newData;
            chart.update('none'); // Actualizar sin animaci√≥n para suavidad
        }
    }
    
    /**
     * Anima un n√∫mero desde un valor inicial a uno final
     */
    function animateNumber(element, start, end) {
        const duration = 500;
        const startTime = performance.now();
        
        function updateNumber(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const current = Math.floor(start + (end - start) * progress);
            element.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(updateNumber);
            }
        }
        
        requestAnimationFrame(updateNumber);
    }
    
    /**
     * Actualiza el tiempo de la √∫ltima actualizaci√≥n
     */
    function updateLastRefreshTime() {
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
            const now = new Date();
            lastUpdateElement.innerHTML = `<i class="fas fa-clock me-1"></i>${now.toLocaleTimeString()}`;
        }
    }
    
    /**
     * ACTUALIZACI√ìN MANUAL FORZADA
     * 
     * Permite al usuario actualizar los resultados manualmente
     * sin esperar el intervalo autom√°tico
     */
    function manualRefresh() {
        updateResults();
        showToast('Resultados actualizados', 'success');
    }
    
    /**
     * ANIMAR LAS BARRAS DE PROGRESO AL CARGAR LA P√ÅGINA
     * 
     * Crea un efecto visual atractivo donde las barras
     * crecen gradualmente desde 0% hasta su valor real
     */
    function animateProgressBars() {
        // Obtener todas las barras de progreso
        const bars = document.querySelectorAll('.result-bar');
        
        bars.forEach((bar, index) => {
            // Obtener el ancho final de la barra
            const width = bar.getAttribute('data-width');
            
            // Empezar desde 0%
            bar.style.width = '0%';
            
            // Animar con retraso escalonado
            setTimeout(() => {
                bar.style.transition = 'width 1s ease-out';
                bar.style.width = `${width}%`;
            }, index * 200); // 200ms de retraso entre cada barra
        });
    }
    
    /* 
    OPTIMIZACIONES DE RENDIMIENTO Y UX:
    Estas funciones mejoran la experiencia del usuario
    */
    
    // LIMPIAR INTERVAL CUANDO SE SALE DE LA P√ÅGINA
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });
    
    // PAUSAR ACTUALIZACI√ìN CUANDO LA VENTANA NO EST√Å VISIBLE
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Usuario cambi√≥ de pesta√±a, pausar actualizaciones
            stopAutoRefresh();
        } else {
            // Usuario volvi√≥, reactivar actualizaciones
            startAutoRefresh();
            updateResults(); // Actualizar inmediatamente al volver
        }
    });
</script>
{% endblock %}

<!-- 
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
GU√çA EDUCATIVA COMPLETA - PLANTILLA DE RESULTADOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RESUMEN DE FUNCIONALIDADES:

1. VISUALIZACI√ìN DE DATOS:
   ‚úÖ Estad√≠sticas num√©ricas (votos totales, opciones, participaci√≥n)
   ‚úÖ Barras de progreso animadas con porcentajes
   ‚úÖ Gr√°fico circular interactivo con Chart.js
   ‚úÖ Indicadores visuales del voto del usuario

2. ACTUALIZACI√ìN EN TIEMPO REAL:
   ‚úÖ Actualizaci√≥n autom√°tica cada 30 segundos
   ‚úÖ Indicadores visuales de estado de actualizaci√≥n
   ‚úÖ Pausa inteligente cuando la ventana no est√° visible
   ‚úÖ Actualizaci√≥n manual bajo demanda

3. EXPERIENCIA DE USUARIO:
   ‚úÖ Animaciones suaves y atractivas
   ‚úÖ Dise√±o responsivo para todos los dispositivos
   ‚úÖ Estados vac√≠os informativos
   ‚úÖ Navegaci√≥n intuitiva entre p√°ginas

TECNOLOG√çAS INTEGRADAS:

‚îú‚îÄ‚îÄ DJANGO TEMPLATE LANGUAGE
‚îÇ   ‚îú‚îÄ‚îÄ extends - Herencia de plantillas
‚îÇ   ‚îú‚îÄ‚îÄ block - Secciones personalizables
‚îÇ   ‚îú‚îÄ‚îÄ if - L√≥gica condicional
‚îÇ   ‚îú‚îÄ‚îÄ for - Bucles para datos din√°micos
‚îÇ   ‚îú‚îÄ‚îÄ variable - Inserci√≥n de valores
‚îÇ   ‚îî‚îÄ‚îÄ filtros - Transformaci√≥n de datos

‚îú‚îÄ‚îÄ BOOTSTRAP 5
‚îÇ   ‚îú‚îÄ‚îÄ Sistema de grid responsivo
‚îÇ   ‚îú‚îÄ‚îÄ Componentes (cards, buttons, badges)
‚îÇ   ‚îú‚îÄ‚îÄ Utilidades de espaciado
‚îÇ   ‚îî‚îÄ‚îÄ Clases de color y tipograf√≠a

‚îú‚îÄ‚îÄ CHART.JS
‚îÇ   ‚îú‚îÄ‚îÄ Gr√°ficos interactivos
‚îÇ   ‚îú‚îÄ‚îÄ Animaciones autom√°ticas
‚îÇ   ‚îú‚îÄ‚îÄ Configuraci√≥n responsiva
‚îÇ   ‚îî‚îÄ‚îÄ Personalizaci√≥n de colores

‚îú‚îÄ‚îÄ JAVASCRIPT MODERNO
‚îÇ   ‚îú‚îÄ‚îÄ addEventListener() - Manejo de eventos
‚îÇ   ‚îú‚îÄ‚îÄ fetch() - Peticiones AJAX
‚îÇ   ‚îú‚îÄ‚îÄ setTimeout() - Temporizadores
‚îÇ   ‚îú‚îÄ‚îÄ Promise - Programaci√≥n as√≠ncrona
‚îÇ   ‚îî‚îÄ‚îÄ DOM manipulation - Actualizaci√≥n din√°mica

‚îî‚îÄ‚îÄ CSS PERSONALIZADO
    ‚îú‚îÄ‚îÄ Animaciones con @keyframes
    ‚îú‚îÄ‚îÄ Transiciones suaves
    ‚îú‚îÄ‚îÄ Variables CSS personalizadas
    ‚îî‚îÄ‚îÄ Responsive design

FLUJO DE DATOS:

1. CARGA INICIAL:
   Usuario accede ‚Üí Vista results() ‚Üí Consulta BD ‚Üí 
   C√°lculo estad√≠sticas ‚Üí Renderizado plantilla ‚Üí 
   Inicializaci√≥n JavaScript ‚Üí Creaci√≥n gr√°ficos

2. ACTUALIZACI√ìN AUTOM√ÅTICA:
   Timer 30s ‚Üí Petici√≥n AJAX ‚Üí Vista results_api() ‚Üí 
   JSON response ‚Üí Actualizaci√≥n DOM ‚Üí Animaciones

3. INTERACCI√ìN USUARIO:
   Click manual ‚Üí updateResults() ‚Üí 
   Fetch datos ‚Üí Actualizar elementos ‚Üí 
   Mostrar feedback

BUENAS PR√ÅCTICAS IMPLEMENTADAS:

üîí SEGURIDAD:
   - Escape de datos con |escapejs
   - Validaci√≥n de entrada
   - Protecci√≥n CSRF en formularios

‚ö° RENDIMIENTO:
   - Carga diferida de recursos
   - Pausar updates en pesta√±as inactivas
   - Limpieza de intervals

‚ôø ACCESIBILIDAD:
   - Texto alternativo en gr√°ficos
   - Contraste de colores adecuado
   - Navegaci√≥n por teclado

üì± RESPONSIVE:
   - Grid flexible de Bootstrap
   - Canvas responsivo
   - Texto adaptativo

CONCEPTOS DJANGO AVANZADOS:

1. TEMPLATE FILTERS:
   - |pluralize: Pluralizaci√≥n autom√°tica
   - |escapejs: Escape para JavaScript
   - |length: Conteo de elementos
   - |timesince: Tiempo transcurrido

2. CONTEXT PROCESSORS:
   - Datos compartidos entre templates
   - Variables globales disponibles

3. TEMPLATE INHERITANCE:
   - base.html como plantilla padre
   - Bloques espec√≠ficos para contenido
   - CSS y JS modulares

4. URL REVERSING:
   - Etiqueta url para generar enlaces
   - Namespace para organizaci√≥n
   - Par√°metros din√°micos

OPTIMIZACIONES APLICADAS:

‚Ä¢ Lazy loading de gr√°ficos
‚Ä¢ Debounce en actualizaciones
‚Ä¢ Memoria eficiente con cleanup
‚Ä¢ Batch updates del DOM
‚Ä¢ CSS animations via GPU
‚Ä¢ Progressive enhancement

DEBUGGING TIPS:

üêõ PROBLEMAS COMUNES:
   - Chart.js no carga: Verificar CDN
   - Updates no funcionan: Revisar JavaScript console
   - Estilos rotos: Verificar Bootstrap CDN
   - Datos incorrectos: Revisar vista results()

üìã HERRAMIENTAS √öTILES:
   - DevTools > Network para AJAX
   - DevTools > Console para errores JS
   - Django Debug Toolbar para consultas BD
   - Browser responsive mode para mobile

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
